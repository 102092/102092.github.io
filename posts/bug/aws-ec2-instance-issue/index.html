<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>AWS EC2 instance issue | 나뭇가지</title>
<meta name=keywords content="bug,aws">
<meta name=description content="1. 버그 내용  특정 시간만 되면 혹은 간헐적이나 지속적으로, Redis 운영에 장애가 생김. (약 10분 ~ 20분) Error Log -> ... Redis command timed out;  로그 내용으로 보아, 어떠한 이유에서 인 지 레디스 멈췄고, 다른 작업들을 처리하지 못해서 생기는 이슈 같음.    2. 생각해볼 수 있는 원인   특정 작업을 처리하는 데, 시간이 오래 걸려서, 레디스에서 병목이 생기는거 아닐까?
 slow log 찾아볼 것 SLOWLOG subcommand    특정 시간에 너무 많은 키가 expire 되어서 발생한 문제가 아닐까?">
<meta name=author content="Han">
<link rel=canonical href=https://102092.github.io/posts/bug/aws-ec2-instance-issue/>
<meta name=google-site-verification content="G-M00DV5S2CX">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.9f1d947375927e9847272b1f4e9be81336f539e513bf04d52cade31f81cad1af.css integrity="sha256-nx2Uc3WSfphHJysfTpvoEzb1OeUTvwTVLK3jH4HK0a8=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://102092.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://102092.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://102092.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://102092.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://102092.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<meta property="og:title" content="AWS EC2 instance issue">
<meta property="og:description" content="1. 버그 내용  특정 시간만 되면 혹은 간헐적이나 지속적으로, Redis 운영에 장애가 생김. (약 10분 ~ 20분) Error Log -> ... Redis command timed out;  로그 내용으로 보아, 어떠한 이유에서 인 지 레디스 멈췄고, 다른 작업들을 처리하지 못해서 생기는 이슈 같음.    2. 생각해볼 수 있는 원인   특정 작업을 처리하는 데, 시간이 오래 걸려서, 레디스에서 병목이 생기는거 아닐까?
 slow log 찾아볼 것 SLOWLOG subcommand    특정 시간에 너무 많은 키가 expire 되어서 발생한 문제가 아닐까?">
<meta property="og:type" content="article">
<meta property="og:url" content="https://102092.github.io/posts/bug/aws-ec2-instance-issue/"><meta property="og:image" content="https://avatars.githubusercontent.com/u/71244638?v=4"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-09-03T00:00:00+00:00">
<meta property="article:modified_time" content="2021-09-03T00:00:00+00:00"><meta property="og:site_name" content="나뭇가지">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://avatars.githubusercontent.com/u/71244638?v=4">
<meta name=twitter:title content="AWS EC2 instance issue">
<meta name=twitter:description content="1. 버그 내용  특정 시간만 되면 혹은 간헐적이나 지속적으로, Redis 운영에 장애가 생김. (약 10분 ~ 20분) Error Log -> ... Redis command timed out;  로그 내용으로 보아, 어떠한 이유에서 인 지 레디스 멈췄고, 다른 작업들을 처리하지 못해서 생기는 이슈 같음.    2. 생각해볼 수 있는 원인   특정 작업을 처리하는 데, 시간이 오래 걸려서, 레디스에서 병목이 생기는거 아닐까?
 slow log 찾아볼 것 SLOWLOG subcommand    특정 시간에 너무 많은 키가 expire 되어서 발생한 문제가 아닐까?">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://102092.github.io/posts/"},{"@type":"ListItem","position":3,"name":"AWS EC2 instance issue","item":"https://102092.github.io/posts/bug/aws-ec2-instance-issue/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS EC2 instance issue","name":"AWS EC2 instance issue","description":"1. 버그 내용  특정 시간만 되면 혹은 간헐적이나 지속적으로, Redis 운영에 장애가 생김. (약 10분 ~ 20분) Error Log -\u0026gt; ... Redis command timed out;  로그 내용으로 보아, 어떠한 이유에서 인 지 레디스 멈췄고, 다른 작업들을 처리하지 못해서 생기는 이슈 같음.    2. 생각해볼 수 있는 원인   특정 작업을 처리하는 데, 시간이 오래 걸려서, 레디스에서 병목이 생기는거 아닐까?\n slow log 찾아볼 것 SLOWLOG subcommand    특정 시간에 너무 많은 키가 expire 되어서 발생한 문제가 아닐까?","keywords":["bug","aws"],"articleBody":"1. 버그 내용  특정 시간만 되면 혹은 간헐적이나 지속적으로, Redis 운영에 장애가 생김. (약 10분 ~ 20분) Error Log - ... Redis command timed out;  로그 내용으로 보아, 어떠한 이유에서 인 지 레디스 멈췄고, 다른 작업들을 처리하지 못해서 생기는 이슈 같음.    2. 생각해볼 수 있는 원인   특정 작업을 처리하는 데, 시간이 오래 걸려서, 레디스에서 병목이 생기는거 아닐까?\n slow log 찾아볼 것 SLOWLOG subcommand    특정 시간에 너무 많은 키가 expire 되어서 발생한 문제가 아닐까?\n 에러 발생한 시간 대, 키들의 expire 되고 있는 시간을 조절.    해당 시간 진행되는 작업 중, 발생하는 트랜잭션에서 뭔가 문제가 발생한 건 아닐까?\n 코드 점검 트랜잭션 진행되고 있는 코드 확인.    AWS EC2 instance issue 일수도..?\n 문서 를 참고하여, reboot - stop and start 순으로 시도해보기.    3. 해결 시도   우선 팀에서 필요하다고 생각되는 부분을 개선.\n redis connection pool 조정. redis tcp-keepalive 조정을 통한 connection 확인. 추후 에러 빈도가 낮아지면, 사용 중인 라이브러리를 JEDIS - Lettuce 로 변경.  Lettuce 의 경우, 커넥션 풀 없이 사용할 수 있도록 디자인 되어 있어서 선택.      1번 해결방안 시도 후, 어느정도 에러 발생 빈도가 줄어드는 것 같이 보였지만, 특정 시간에 발생하는 레디스 에러는 여전히 있었음.\n 즉 connection pool로 인해 발생된 에러가 아닌듯. 작성된 코드 이슈?  에러가 발생하는 코드 중에, 레디스 키를 expire 하는 부분에 delay를 줌. 또한, SMEMEBER 사용하는 코드를 SSCAN 으로 변경하는 등의 개선 작업 진행.      여전히 발생. 또한 레디스에서 파생된 에러로 인해 Database 까지 전파되는듯 함.\n 해당 에러가 발생하는 시간 대에, 인스턴스 내부에 cronjob 을 수행되나, ssh 를 통한 접근이 불가함을 파악 또한, 해당 시간 전에 AWS EC2 검사 실패가 발생함을 확인. AWS EC2 Reboot 하기로 결정.  서버 off - redis-save - ec2 reboot - redis on 확인 - 서버 on 과정을 진행 (다행히 5분내에 끝났다.)      Redis 랑 지속적으로 커넥션을 맺고 있는 서버 내림(에러 발생 원인을 명확하게 하기 위해).\n AWS EC2 Detailed monitoring 활성화. 그래도 에러 발생 (AWS EC2 instance 검사 실패, 인스턴스 접속 불가, Redis monioring 접근 불가) 네크워크 이슈? AWS EC2 stop - start를 통해 호스트 변경. 다행스럽게도 해결    5. 정리  발생한 이슈는 AWS EC2 Instacne 이슈였던듯 싶음. 지금 되돌아보면, 몇가지 시그널을 있었던 듯. (네트워크 관련..) 이중화.. 구조의 필요성을 느꼈음.  하나가 장애가 나더라도, 바로 대체할 수 있도록.    6. 참고  https://jihooyim1.gitbooks.io/linuxbasic/content/contents/08.html https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html#lifecycle-differences https://redis.io/commands/  ","wordCount":"351","inLanguage":"en","datePublished":"2021-09-03T00:00:00Z","dateModified":"2021-09-03T00:00:00Z","author":{"@type":"Person","name":"Han"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://102092.github.io/posts/bug/aws-ec2-instance-issue/"},"publisher":{"@type":"Organization","name":"나뭇가지","logo":{"@type":"ImageObject","url":"https://102092.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://102092.github.io accesskey=h title="나뭇가지 (Alt + H)">나뭇가지</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://102092.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://102092.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://102092.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://102092.github.io>Home</a>&nbsp;»&nbsp;<a href=https://102092.github.io/posts/>Posts</a></div>
<h1 class=post-title>
AWS EC2 instance issue
</h1>
<div class=post-meta>September 3, 2021&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Han&nbsp;|&nbsp;<a href=https://github.com/102092/102092.github.io/blob/dev/content/posts/bug/aws-ec2-instance-issue.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content><h1 id=1-버그-내용>1. 버그 내용<a hidden class=anchor aria-hidden=true href=#1-버그-내용>#</a></h1>
<ul>
<li>특정 시간만 되면 혹은 간헐적이나 지속적으로, Redis 운영에 장애가 생김. (약 10분 ~ 20분)</li>
<li>Error Log -> <code>... Redis command timed out;</code>
<ul>
<li>로그 내용으로 보아, 어떠한 이유에서 인 지 레디스 멈췄고,</li>
<li>다른 작업들을 처리하지 못해서 생기는 이슈 같음.</li>
</ul>
</li>
</ul>
<h1 id=2-생각해볼-수-있는-원인>2. 생각해볼 수 있는 원인<a hidden class=anchor aria-hidden=true href=#2-생각해볼-수-있는-원인>#</a></h1>
<ol>
<li>
<p>특정 작업을 처리하는 데, 시간이 오래 걸려서, 레디스에서 병목이 생기는거 아닐까?</p>
<ul>
<li><code>slow log</code> 찾아볼 것</li>
<li><a href=https://redis.io/commands/slowlog>SLOWLOG subcommand</a></li>
</ul>
</li>
<li>
<p>특정 시간에 너무 많은 키가 <code>expire</code> 되어서 발생한 문제가 아닐까?</p>
<ul>
<li>에러 발생한 시간 대, 키들의 <code>expire</code> 되고 있는 시간을 조절.</li>
</ul>
</li>
<li>
<p>해당 시간 진행되는 작업 중, 발생하는 트랜잭션에서 뭔가 문제가 발생한 건 아닐까?</p>
<ul>
<li>코드 점검</li>
<li>트랜잭션 진행되고 있는 코드 확인.</li>
</ul>
</li>
<li>
<p>AWS EC2 instance issue 일수도..?</p>
<ul>
<li><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html#lifecycle-differences>문서</a> 를 참고하여, <code>reboot</code> -> <code>stop and start</code> 순으로 시도해보기.</li>
</ul>
</li>
</ol>
<h1 id=3-해결-시도>3. 해결 시도<a hidden class=anchor aria-hidden=true href=#3-해결-시도>#</a></h1>
<ol>
<li>
<p>우선 팀에서 필요하다고 생각되는 부분을 개선.</p>
<ul>
<li>redis connection pool 조정.</li>
<li>redis tcp-keepalive 조정을 통한 connection 확인.</li>
<li>추후 에러 빈도가 낮아지면, 사용 중인 라이브러리를 <code>JEDIS</code> -> <code>Lettuce</code> 로 변경.
<ul>
<li><code>Lettuce</code> 의 경우, 커넥션 풀 없이 사용할 수 있도록 디자인 되어 있어서 선택.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>1번 해결방안 시도 후, 어느정도 에러 발생 빈도가 줄어드는 것 같이 보였지만, 특정 시간에 발생하는 레디스 에러는 여전히 있었음.</p>
<ul>
<li>즉 connection pool로 인해 발생된 에러가 아닌듯.</li>
<li>작성된 코드 이슈?
<ul>
<li>에러가 발생하는 코드 중에, 레디스 키를 expire 하는 부분에 delay를 줌.</li>
<li>또한, <a href=https://redis.io/commands/smembers>SMEMEBER</a> 사용하는 코드를 <a href=https://redis.io/commands/sscan>SSCAN</a> 으로 변경하는 등의 개선 작업 진행.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>여전히 발생. 또한 레디스에서 파생된 에러로 인해 <code>Database</code> 까지 전파되는듯 함.</p>
<ul>
<li>해당 에러가 발생하는 시간 대에, 인스턴스 내부에 cronjob 을 수행되나, <code>ssh</code> 를 통한 접근이 불가함을 파악</li>
<li>또한, 해당 시간 전에 AWS EC2 검사 실패가 발생함을 확인.</li>
<li>AWS EC2 Reboot 하기로 결정.
<ul>
<li>서버 off -> redis-save -> ec2 reboot -> redis on 확인 -> 서버 on 과정을 진행</li>
<li>(다행히 5분내에 끝났다.)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Redis 랑 지속적으로 커넥션을 맺고 있는 서버 내림(에러 발생 원인을 명확하게 하기 위해).</p>
<ul>
<li>AWS EC2 Detailed monitoring 활성화.</li>
<li>그래도 에러 발생 (AWS EC2 instance 검사 실패, 인스턴스 접속 불가, Redis monioring 접근 불가)</li>
<li>네크워크 이슈?</li>
<li>AWS EC2 stop -> start를 통해 호스트 변경.</li>
<li>다행스럽게도 해결</li>
</ul>
</li>
</ol>
<h1 id=5-정리>5. 정리<a hidden class=anchor aria-hidden=true href=#5-정리>#</a></h1>
<ul>
<li>발생한 이슈는 <strong>AWS EC2 Instacne 이슈</strong>였던듯 싶음.</li>
<li>지금 되돌아보면, 몇가지 시그널을 있었던 듯. (네트워크 관련..)</li>
<li>이중화.. 구조의 필요성을 느꼈음.
<ul>
<li>하나가 장애가 나더라도, 바로 대체할 수 있도록.</li>
</ul>
</li>
</ul>
<h1 id=6-참고>6. 참고<a hidden class=anchor aria-hidden=true href=#6-참고>#</a></h1>
<ul>
<li><a href=https://jihooyim1.gitbooks.io/linuxbasic/content/contents/08.html>https://jihooyim1.gitbooks.io/linuxbasic/content/contents/08.html</a></li>
<li><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html#lifecycle-differences>https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-lifecycle.html#lifecycle-differences</a></li>
<li><a href=https://redis.io/commands/>https://redis.io/commands/</a></li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://102092.github.io/tags/bug/>bug</a></li>
<li><a href=https://102092.github.io/tags/aws/>aws</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://102092.github.io/posts/spring/what-is-mapped-by-annotation/>
<span class=title>« Prev Page</span>
<br>
<span>Mapped By</span>
</a>
<a class=next href=https://102092.github.io/posts/bug/fail-to-read-auto-increment-value/>
<span class=title>Next Page »</span>
<br>
<span>Failed to read auto-increment value from storage engine</span>
</a>
</nav>
</footer><script src=https://utteranc.es/client.js repo=102092/comments issue-term=title theme=github-light crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://102092.github.io>나뭇가지</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>